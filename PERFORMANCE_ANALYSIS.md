# –ê–Ω–∞–ª—ñ–∑ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ ChunkManager - –ö—Ä–∏—Ç–∏—á–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏

## –ü—Ä–æ–±–ª–µ–º–∞: FPS –ø–∞–¥–∞—î –∑ 260 –¥–æ 40 –ø—Ä–∏ –±—ñ–≥—É (loadRadius=10, maxIntegrationsPerFrame=10)

---

## üî¥ –ö–†–ò–¢–ò–ß–ù–Ü BOTTLENECK'–ò (–≤ –ø–æ—Ä—è–¥–∫—É –≤–∞–∂–ª–∏–≤–æ—Å—Ç—ñ)

### 1. **GatherNeighborCopies() - –°–ò–ù–•–†–û–ù–ù–ï –ö–û–ü–Ü–Æ–í–ê–ù–ù–Ø –ù–ê MAIN THREAD**
**–õ–æ–∫–∞—Ü—ñ—è:** `ChunkManager.cs:894-950`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ö–û–ñ–ï–ù –†–ê–ó –ø—Ä–∏ `ScheduleMeshForChunk()` (—Ä—è–¥–æ–∫ 861)
- –ö–æ–ø—ñ—é—î –¥–æ 6 NativeArray –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ —Å—É—Å—ñ–¥—ñ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –Ω–∞ main thread
- –†–æ–∑–º—ñ—Ä: `32*32*32*2 bytes = 65,536 bytes (64KB)` –Ω–∞ —Å—É—Å—ñ–¥–∞
- –ü—Ä–∏ loadRadius=10: –º–æ–∂–µ –±—É—Ç–∏ 10-20 mesh jobs/–∫–∞–¥—Ä
- **–í—Å—å–æ–≥–æ: 6*64KB*20 = 7.8MB –∫–æ–ø—ñ–π –Ω–∞ –∫–∞–¥—Ä –Ω–∞ main thread!**

**–ö–æ–¥:**
```csharp
buffers.NegX = new NativeArray<ushort>(negX.Data.Materials.Length, Allocator.Persistent);
NativeArray<ushort>.Copy(negX.Data.Materials, buffers.NegX); // –°–ò–ù–•–†–û–ù–ù–û –ë–õ–û–ö–£–Ñ
```

**–í–ø–ª–∏–≤:** –¶–µ –Ω–∞–π–±—ñ–ª—å—à–∏–π bottleneck - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è 7.8MB –±–ª–æ–∫—É—é main thread.

**–†—ñ—à–µ–Ω–Ω—è:**
- –ö–µ—à—É–≤–∞—Ç–∏ neighbor copies (—è–∫—â–æ —Å—É—Å—ñ–¥ –Ω–µ –∑–º—ñ–Ω–∏–≤—Å—è, reuse)
- –ê–±–æ –∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (Burst job –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è)
- –ê–±–æ –æ–±–º–µ–∂–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å mesh jobs/–∫–∞–¥—Ä (–≤–∂–µ —î maxMeshJobsInFlight=2, –∞–ª–µ GatherNeighborCopies –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –î–û –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏)

---

### 2. **MaintainRadius() - O(n¬≤) –û–ü–ï–†–ê–¶–Ü–á –ö–û–ñ–ï–ù –ö–ê–î–†**
**–õ–æ–∫–∞—Ü—ñ—è:** `ChunkManager.cs:404-485`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ö–û–ñ–ï–ù –ö–ê–î–† –≤ Update() (—Ä—è–¥–æ–∫ 313)
- –ü—Ä–∏ loadRadius=10, ColumnChunks=8: `10*10*8 = 800` —ñ—Ç–µ—Ä–∞—Ü—ñ–π
- –î–ª—è –∫–æ–∂–Ω–æ–≥–æ coord:
  - `_active.TryGetValue()` - O(1) ‚úÖ
  - `_pending.Contains(coord)` - **O(n) –ü–†–û–ë–õ–ï–ú–ê!** Queue.Contains –ø–µ—Ä–µ–≤—ñ—Ä—è—î –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
  - `_preloaded.Contains()` - O(1) ‚úÖ
  - `needed.Add()` - O(1) ‚úÖ
- –ü–æ—Ç—ñ–º —â–µ –æ–¥–∏–Ω —Ü–∏–∫–ª –¥–ª—è preload radius
- –ü–æ—Ç—ñ–º —â–µ –æ–¥–∏–Ω —Ü–∏–∫–ª –¥–ª—è keep radius
- –ü–æ—Ç—ñ–º `foreach (_active)` –∑ `keep.Contains()` - O(n*m) –¥–µ n=active chunks, m=keep coords

**–í–ø–ª–∏–≤:** –ü—Ä–∏ 1000+ –∞–∫—Ç–∏–≤–Ω–∏—Ö —á–∞–Ω–∫—ñ–≤ —Ç–∞ loadRadius=10: —Ç–∏—Å—è—á—ñ O(n) –æ–ø–µ—Ä–∞—Ü—ñ–π –∫–æ–∂–µ–Ω –∫–∞–¥—Ä.

**–†—ñ—à–µ–Ω–Ω—è:**
- –ó–∞–º—ñ–Ω–∏—Ç–∏ `_pending.Contains()` –Ω–∞ `HashSet<ChunkCoord> _pendingSet` –¥–ª—è O(1) –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- –ö–µ—à—É–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç MaintainRadius (–≤–∏–∫–ª–∏–∫–∞—Ç–∏ –Ω–µ –∫–æ–∂–µ–Ω –∫–∞–¥—Ä, –∞ –∫–æ–∂–Ω—ñ 2-3 –∫–∞–¥—Ä–∏)
- –û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ —Ü–∏–∫–ª –ø–æ _active (–≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ HashSet –¥–ª—è keep –∑–∞–º—ñ—Å—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–æ–∂–Ω–æ–≥–æ)

---

### 3. **RebuildNeighbors() - –ö–ê–°–ö–ê–î REMESH –û–ü–ï–†–ê–¶–Ü–ô**
**–õ–æ–∫–∞—Ü—ñ—è:** `ChunkManager.cs:1365-1373`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è –ö–û–ñ–ù–û–á —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó (—Ä—è–¥–æ–∫ 686)
- –°—Ç–≤–æ—Ä—é—î 6 `QueueRemesh()` –≤–∏–∫–ª–∏–∫—ñ–≤ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —á–∞–Ω–∫–∞
- –ü—Ä–∏ maxIntegrationsPerFrame=10: **60 remesh –æ–ø–µ—Ä–∞—Ü—ñ–π/–∫–∞–¥—Ä**
- –ö–æ–∂–µ–Ω remesh ‚Üí ScheduleMeshForChunk ‚Üí GatherNeighborCopies ‚Üí —â–µ 6 –∫–æ–ø—ñ–π

**–í–ø–ª–∏–≤:** –ö–∞—Å–∫–∞–¥–Ω–∏–π –µ—Ñ–µ–∫—Ç - –æ–¥–∏–Ω —á–∞–Ω–∫ —ñ–Ω—Ç–µ–≥—Ä—É—î—Ç—å—Å—è ‚Üí 6 —Å—É—Å—ñ–¥—ñ–≤ remesh ‚Üí 36 —Å—É—Å—ñ–¥—ñ–≤ —Å—É—Å—ñ–¥—ñ–≤ remesh...

**–†—ñ—à–µ–Ω–Ω—è:**
- –û–±–º–µ–∂–∏—Ç–∏ RebuildNeighbors (–Ω–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó, –∞ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Å—É—Å—ñ–¥ —â–µ –Ω–µ –º–µ—à–∏–≤—Å—è)
- –î–æ–¥–∞—Ç–∏ debounce –¥–ª—è remesh (—á–µ–∫–∞—Ç–∏ 2-3 –∫–∞–¥—Ä–∏ –ø–µ—Ä–µ–¥ remesh)
- –ê–±–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ RebuildNeighbors –Ω–µ –≤ ProcessIntegrationQueue, –∞ –≤ –æ–∫—Ä–µ–º–æ–º—É –º–µ—Ç–æ–¥—ñ –∑ –ª—ñ–º—ñ—Ç–æ–º

---

### 4. **Queue.Contains() - O(n) –í –ì–ê–†–Ø–ß–û–ú–£ –®–õ–Ø–•–Ü**
**–õ–æ–∫–∞—Ü—ñ—è:** `ChunkManager.cs:427` (–≤ MaintainRadius)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `_pending.Contains(coord)` - Queue –Ω–µ –º–∞—î O(1) Contains, –ø–µ—Ä–µ–≤—ñ—Ä—è—î –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
- –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è 800 —Ä–∞–∑—ñ–≤/–∫–∞–¥—Ä –ø—Ä–∏ loadRadius=10

**–í–ø–ª–∏–≤:** –ü—Ä–∏ –≤–µ–ª–∏–∫—ñ–π —á–µ—Ä–∑—ñ (1000+ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤) - 800*1000 = 800,000 –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫/–∫–∞–¥—Ä.

**–†—ñ—à–µ–Ω–Ω—è:**
- –î–æ–¥–∞—Ç–∏ `HashSet<ChunkCoord> _pendingSet` –¥–ª—è O(1) –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- –ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –º—ñ–∂ Queue —Ç–∞ HashSet

---

### 5. **ProcessRemeshQueue() - –ë–ï–ó –õ–Ü–ú–Ü–¢–£ –ù–ê –ö–ê–°–ö–ê–î**
**–õ–æ–∫–∞—Ü—ñ—è:** `ChunkManager.cs:1100+` (–ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞–π—Ç–∏)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –Ø–∫—â–æ RebuildNeighbors —Å—Ç–≤–æ—Ä—é—î 60 remesh –æ–ø–µ—Ä–∞—Ü—ñ–π, –∞ maxRemeshPerFrame=2, —á–µ—Ä–≥–∞ —Ä–æ—Å—Ç–µ
- –ú–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Å–æ—Ç–Ω—ñ remesh –æ–ø–µ—Ä–∞—Ü—ñ–π, —è–∫—ñ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –ø–æ–≤—ñ–ª—å–Ω–æ

**–í–ø–ª–∏–≤:** –ß–µ—Ä–≥–∞ remesh —Ä–æ—Å—Ç–µ –±–µ–∑–∫—ñ–Ω–µ—á–Ω–æ –ø—Ä–∏ —à–≤–∏–¥–∫–æ–º—É —Ä—É—Å—ñ.

**–†—ñ—à–µ–Ω–Ω—è:**
- –î–æ–¥–∞—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä _remeshQueue
- –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—ñ - –æ—á–∏—â–∞—Ç–∏ —Å—Ç–∞—Ä—ñ remesh –∑–∞–ø–∏—Ç–∏
- –ê–±–æ –æ–±–º–µ–∂–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å remesh –æ–ø–µ—Ä–∞—Ü—ñ–π –Ω–∞ –æ–¥–∏–Ω —á–∞–Ω–∫ (–Ω–µ remesh —Å—É—Å—ñ–¥—ñ–≤ —Å—É—Å—ñ–¥—ñ–≤)

---

### 6. **NativeArray –∞–ª–æ–∫–∞—Ü—ñ—ó –≤ ScheduleMeshForChunk**
**–õ–æ–∫–∞—Ü—ñ—è:** `ChunkManager.cs:862-871`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–æ–∂–µ–Ω mesh job —Å—Ç–≤–æ—Ä—é—î:
  - `materialsCopy` (32*32*32*2 = 64KB)
  - `mask` (32*32*sizeof(MaskCell))
  - `empty` (0 bytes, –∞–ª–µ –≤—Å–µ –æ–¥–Ω–æ –∞–ª–æ–∫–∞—Ü—ñ—è)
- –ü—Ä–∏ 10 mesh jobs/–∫–∞–¥—Ä = 10 –∞–ª–æ–∫–∞—Ü—ñ–π NativeArray

**–í–ø–ª–∏–≤:** GC pressure, –∞–ª–æ–∫–∞—Ü—ñ–π–Ω—ñ —Å–ø–∞–π–∫–∏.

**–†—ñ—à–µ–Ω–Ω—è:**
- Pool –¥–ª—è NativeArray (reuse materialsCopy, mask)
- –ê–±–æ –æ–±–º–µ–∂–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å mesh jobs/–∫–∞–¥—Ä (–≤–∂–µ —î maxMeshJobsInFlight=2)

---

## üü° –°–ï–†–ï–î–ù–Ü –ü–†–û–ë–õ–ï–ú–ò

### 7. **Dictionary lookups –≤ –≥–∞—Ä—è—á–∏—Ö —à–ª—è—Ö–∞—Ö**
- –ë–∞–≥–∞—Ç–æ `TryGetValue()` –≤ Update() - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –∞–ª–µ –º–æ–∂–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏

### 8. **HashSet –æ–ø–µ—Ä–∞—Ü—ñ—ó –≤ —Ü–∏–∫–ª–∞—Ö**
- `needed.Add()`, `keep.Add()` - O(1), –∞–ª–µ –ø—Ä–∏ 800 —ñ—Ç–µ—Ä–∞—Ü—ñ—è—Ö –º–æ–∂–µ –±—É—Ç–∏ overhead

### 9. **PlayerTracker.WorldToChunk() –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –±–∞–≥–∞—Ç–æ —Ä–∞–∑—ñ–≤**
- –í MaintainRadius, ProcessPending, ProcessPreload - –º–æ–∂–Ω–∞ –∫–µ—à—É–≤–∞—Ç–∏

---

## üìä –ü–†–ò–ö–õ–ê–î –†–û–ó–†–ê–•–£–ù–ö–£ –ù–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø

**–ü—Ä–∏ loadRadius=10, ColumnChunks=8, –∞–∫—Ç–∏–≤–Ω–∏—Ö —á–∞–Ω–∫—ñ–≤=500:**

**MaintainRadius (–∫–æ–∂–µ–Ω –∫–∞–¥—Ä):**
- –¶–∏–∫–ª needed: 10*10*8 = 800 —ñ—Ç–µ—Ä–∞—Ü—ñ–π
- Dictionary.TryGetValue: 800 —Ä–∞–∑—ñ–≤ (O(1)) = 800 –æ–ø–µ—Ä–∞—Ü—ñ–π
- Queue.Contains: 800 —Ä–∞–∑—ñ–≤ (O(n), n=1000) = **800,000 –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫**
- HashSet.Add: 800 —Ä–∞–∑—ñ–≤ (O(1)) = 800 –æ–ø–µ—Ä–∞—Ü—ñ–π
- –¶–∏–∫–ª preload: ~200 —ñ—Ç–µ—Ä–∞—Ü—ñ–π
- –¶–∏–∫–ª keep: 10*10*8 = 800 —ñ—Ç–µ—Ä–∞—Ü—ñ–π
- foreach _active: 500 —ñ—Ç–µ—Ä–∞—Ü—ñ–π –∑ HashSet.Contains = 500 –æ–ø–µ—Ä–∞—Ü—ñ–π
- **–í—Å—å–æ–≥–æ: ~802,000 –æ–ø–µ—Ä–∞—Ü—ñ–π/–∫–∞–¥—Ä —Ç—ñ–ª—å–∫–∏ –≤ MaintainRadius**

**GatherNeighborCopies (–ø—Ä–∏ 10 mesh jobs/–∫–∞–¥—Ä):**
- 10 jobs * 6 neighbors * 64KB = **3.84MB –∫–æ–ø—ñ–π/–∫–∞–¥—Ä –Ω–∞ main thread**

**RebuildNeighbors (–ø—Ä–∏ 10 —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π/–∫–∞–¥—Ä):**
- 10 * 6 = 60 remesh –æ–ø–µ—Ä–∞—Ü—ñ–π/–∫–∞–¥—Ä
- –ö–æ–∂–µ–Ω remesh ‚Üí GatherNeighborCopies ‚Üí —â–µ 3.84MB –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ

---

## ‚úÖ –ü–†–Ü–û–†–ò–¢–ï–¢–ò –û–ü–¢–ò–ú–Ü–ó–ê–¶–Ü–á

1. **–ö–†–ò–¢–ò–ß–ù–û:** –ó–∞–º—ñ–Ω–∏—Ç–∏ Queue.Contains –Ω–∞ HashSet –¥–ª—è O(1)
2. **–ö–†–ò–¢–ò–ß–ù–û:** –ö–µ—à—É–≤–∞—Ç–∏/–æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ GatherNeighborCopies (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∞–±–æ –∫–µ—à)
3. **–í–ê–ñ–õ–ò–í–û:** –û–±–º–µ–∂–∏—Ç–∏ RebuildNeighbors (debounce –∞–±–æ –ª—ñ–º—ñ—Ç)
4. **–í–ê–ñ–õ–ò–í–û:** –ö–µ—à—É–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç MaintainRadius (–Ω–µ –∫–æ–∂–µ–Ω –∫–∞–¥—Ä)
5. **–°–ï–†–ï–î–ù–¨–û:** Pool –¥–ª—è NativeArray –≤ ScheduleMeshForChunk

---

## üß™ –Ø–ö –ü–ï–†–ï–í–Ü–†–ò–¢–ò

1. –î–æ–¥–∞—Ç–∏ –ø—Ä–æ—Ñ–∞–π–ª—ñ–Ω–≥ –≤ MaintainRadius:
   ```csharp
   var sw = Stopwatch.StartNew();
   MaintainRadius();
   if (sw.ElapsedMilliseconds > 1) Debug.Log($"MaintainRadius: {sw.ElapsedMilliseconds}ms");
   ```

2. –î–æ–¥–∞—Ç–∏ –ø—Ä–æ—Ñ–∞–π–ª—ñ–Ω–≥ –≤ GatherNeighborCopies:
   ```csharp
   var sw = Stopwatch.StartNew();
   var neighbors = GatherNeighborCopies(coord);
   if (sw.ElapsedMilliseconds > 5) Debug.Log($"GatherNeighborCopies: {sw.ElapsedMilliseconds}ms");
   ```

3. –ú–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä _remeshQueue –≤ HUD - —è–∫—â–æ —Ä–æ—Å—Ç–µ –±–µ–∑–∫—ñ–Ω–µ—á–Ω–æ ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ #5
